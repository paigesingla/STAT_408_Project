---
title: "Obesity"
author: "Paige Singla"
date: "2024-11-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(package = MASS)
library(brant)
library(car)
library(caret)
library(VGAM)
library(regclass)
```

## EDA

```{r}
obesity <- read.csv("Data/Obesity.csv")
```


I want to calculate BMI to use as a target variable, this dataset is in metric units so to calculate BMI I will use the following formula. $BMI = \frac{\text{Weight in kg}}{(\text{Height in meters})^2}$
```{r}
# I want to calculate BMI to use as a target variable
obesity$BMI <- obesity$Weight/(obesity$Height)^2

# Since Height and weight were used in calculating BMI it would be repetitive to keep them in the dataset, therefore I will remove them

obesity <- subset(obesity, select = -c(Height, Weight) )

# Checking for missing data
sum(is.na(obesity)) # No missing data

# I want to look at the unique values for each column
# unique(obesity)
```
```{r}
# Lets make some plots

# Boxplot of BMI by Obesity Level

# I first want to order obesity level
obesity$NObeyesdad <- factor(obesity$NObeyesdad , levels=c("Insufficient_Weight", "Normal_Weight", "Overweight_Level_I", "Overweight_Level_II", "Obesity_Type_I", "Obesity_Type_II", "Obesity_Type_III"))
ggplot(obesity, aes(x = NObeyesdad, y = BMI)) +
  geom_boxplot() +
  labs(title = "BMI by Obesity Level",
       x = "Obesity Level",
       y = "BMI") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
We can see that BMI increases as Obesity level increases.

```{r}
#Let me check for multicolinearity
mod <- lm(BMI~.,obesity)

plot(mod,4) + abline(h=4/(2111-1-15))
VIF(mod)
# no immediate concerns about multicolinearity
```

## Creating a "best" model

```{r}
# Checking if I should include any polynomial terms
ggplot(aes(x=Age, y=BMI), data = obesity) + geom_point()

# Does not seem like I need to add any
```

```{r}
mod_max <- lm(BMI~(.-NObeyesdad)*(.-NObeyesdad), obesity)
summary(mod_max)
```
```{r}
# Appears that we have many aliased terms so I will check that and remove any
# We have quite a few aliased terms
alias(mod_max) # I will remove these terms as the will cause warnings and potentially issues later on. 

mod_max <- lm(BMI~.*. - Gender:CALC - Gender:MTRANS - Age:CALC - family_history_with_overweight:CALC - family_history_with_overweight:NObeyesdad - FAVC:CALC - FCVC:CALC - FCVC:NObeyesdad - NCP:CALC - NCP:MTRANS - NCP:NObeyesdad - CAEC:CALC - CAEC:MTRANS - CAEC:NObeyesdad - SMOKE:CALC - SMOKE:MTRANS - CH2O:CALC - SCC:CALC - SCC:MTRANS - SCC:NObeyesdad - FAF:CALC - TUE:CALC - TUE:MTRANS - CALC:MTRANS - CALC:NObeyesdad - MTRANS:NObeyesdad, obesity)
#summary(mod_max)
```

```{r}
# Now to find the "best" model
mod_best <- step(mod_max, direction = "both", trace = 0)
```

```{r}
summary(mod_best)
```


```{r}
plot(mod_best,1)
plot(mod_best,2)
library(lmtest)
bptest(mod_best)
library(zoo)
ks.test(rstandard(mod_best),"pnorm")
```
```{r}
# The assumptions are not met but takes too long to run if I were to try a ton of different transformations so I will run a box cox test to see which transformation I should try

library(MASS)
boxcox(mod_best)

# lambda closes to .05 so i will do a sqrt transformation
mod_max_sqrt <- lm(sqrt(BMI)~.*. - Gender:CALC - Gender:MTRANS - Age:CALC - family_history_with_overweight:CALC - family_history_with_overweight:NObeyesdad - FAVC:CALC - FCVC:CALC - FCVC:NObeyesdad - NCP:CALC - NCP:MTRANS - NCP:NObeyesdad - CAEC:CALC - CAEC:MTRANS - CAEC:NObeyesdad - SMOKE:CALC - SMOKE:MTRANS - CH2O:CALC - SCC:CALC - SCC:MTRANS - SCC:NObeyesdad - FAF:CALC - TUE:CALC - TUE:MTRANS - CALC:MTRANS - CALC:NObeyesdad - MTRANS:NObeyesdad, obesity)

mod_best_sqrt <- step(mod_max_sqrt, direction = "both", trace = 0)
```

```{r}
summary(mod_best_sqrt)
```


```{r}
plot(mod_best_sqrt,1)
plot(mod_best_sqrt,2)
library(lmtest)
bptest(mod_best_sqrt)
library(zoo)
ks.test(rstandard(mod_best_sqrt),"pnorm")
```
We are still having trouble meeting model assumptions. The goal of this project is to attempt to answer the question "What charectoristics of an individuals lifestyle are significant predictors of obesity". Attempting to use a linear regression model with BMI as our response may not accuratlt answer this quesion. Instead I will attempt to run a logistic regression model with the response being Obese or Not, as well as a proportional odds model.



## Logistic Regression


```{r}
obesity_logistic <- obesity %>%
  mutate(obese = ifelse(NObeyesdad %in% c("Insufficient_Weight", "Normal_Weight", "Overweight_Level_I", "Overweight_Level_II"), 0, 1))

obesity_logistic <- subset(obesity_logistic, select = - NObeyesdad)

 mean(obesity_logistic$obese == 1) # roughly 50% split for the logisitc regression so I will continue
 
```
```{r}
mod_log <- glm(obese ~ .  - SCC - BMI, data = obesity_logistic, family = binomial)
summary(mod_log) # Algorithm did not converge will check for multicolinearity and remove variables if needed, found that there was near zero varinca in SCC and perfect seperation in BMI (Still had perfect seperation when i tested with just height and weight)


#VIF(mod_log)
```


While I have now solved the issue of convergence we still may have some variables perfectly splitting the data (however the package detect separation did not detect any). I believe a better model would be a proportional odds model.

## PROPORTIONAL ODDS MODEL

```{r}
# I want to test this with the original dataset
obesity_0 <- read.csv("Data/Obesity.csv")


obesity_po <- obesity_0 %>%
  mutate(obese = ifelse(NObeyesdad %in% c("Insufficient_Weight"), "Insufficient_Weight", ifelse(NObeyesdad %in% c("Normal_Weight"), "Normal_Weight", ifelse(NObeyesdad %in% c("Overweight_Level_I", "Overweight_Level_II"),"Overweight","Obese"))))

obesity_po$obese.order <- factor(obesity_po$obese,
                               levels = c("Insufficient_Weight",  "Normal_Weight", "Overweight","Obese"), ordered = TRUE)

obesity_po <- subset(obesity_po, select = -c(NObeyesdad,obese))



# Again getting errors in convergence and fitted probabilities
# obesity_po[, sapply(obesity_po, is.numeric)] <-
#   scale(obesity_po[, sapply(obesity_po, is.numeric)])



    mod.fit.ord <- 
      polr(formula = obese.order ~ . - Height - Weight - SCC,
           data = obesity_po, method = "logistic")
    #class(mod.fit.ord)
    summary(mod.fit.ord)
    AIC(mod.fit.ord)
    Anova(mod.fit.ord)
         
  
brant(mod.fit.ord)

obesity_po$Gender <- as.factor(obesity_po$Gender)
obesity_po$family_history_with_overweight <- as.factor(obesity_po$family_history_with_overweight)
obesity_po$FAVC <- as.factor(obesity_po$FAVC)
obesity_po$CAEC <- as.factor(obesity_po$CAEC)
obesity_po$SMOKE <- as.factor(obesity_po$SMOKE)
obesity_po$SCC <- as.factor(obesity_po$SCC)
obesity_po$CALC<- as.factor(obesity_po$CALC)
obesity_po$MTRANS <- as.factor(obesity_po$MTRANS)

cor_matrix <- cor(obesity_po[, sapply(obesity_po, is.numeric)], use = "complete.obs")


nearZeroVar(obesity_po, saveMetrics = TRUE)

mod.fit.po <- vglm(formula = obese.order ~ . - Height - Weight - SCC,
                       family = cumulative(parallel = TRUE), data = obesity_po)
mod.fit.npo <- vglm(formula = obese.order ~ . - Height - Weight - SCC,
                        family = cumulative(parallel = FALSE), data = obesity_po)
 
lrtest(mod.fit.npo, mod.fit.po)
```








